# Matchlock Development Dependencies
# Install with: mise install
# Run tasks with: mise run <task>

[tools]
go = "1.25"
golangci-lint = "1.62"
"go:github.com/google/go-containerregistry/cmd/crane" = "latest"

[env]
_.path = ["~/go/bin"]
KERNEL_VERSION = "6.1.137"
OUTPUT_DIR = "{{env.HOME}}/.cache/matchlock"
REGISTRY = "ghcr.io/jingkaihe/matchlock"

# =============================================================================
# Build tasks
# =============================================================================

[tasks.build]
description = "Build the matchlock CLI"
run = "go build -o bin/matchlock ./cmd/matchlock"

[tasks."build:all"]
description = "Build CLI and guest binaries"
depends = ["build", "build:guest"]

[tasks."build:guest"]
description = "Build guest-agent and guest-fused (static Linux binaries, auto-detects arch on macOS)"
run = """
#!/usr/bin/env bash
set -e
mkdir -p bin

# Auto-detect target architecture based on host
GUEST_ARCH="amd64"
if [ "$(uname -s)" = "Darwin" ] && [ "$(uname -m)" = "arm64" ]; then
    GUEST_ARCH="arm64"
fi

CGO_ENABLED=0 GOOS=linux GOARCH=$GUEST_ARCH go build -trimpath -o bin/guest-agent ./cmd/guest-agent
CGO_ENABLED=0 GOOS=linux GOARCH=$GUEST_ARCH go build -trimpath -o bin/guest-fused ./cmd/guest-fused
echo "Built ($GUEST_ARCH): bin/guest-agent, bin/guest-fused"
"""

[tasks."build:guest-arm64"]
description = "Build guest binaries for ARM64 (macOS)"
run = """
#!/usr/bin/env bash
set -e
mkdir -p bin
CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -trimpath -o bin/guest-agent-arm64 ./cmd/guest-agent
CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -trimpath -o bin/guest-fused-arm64 ./cmd/guest-fused
echo "Built: bin/guest-agent-arm64, bin/guest-fused-arm64"
"""

[tasks.clean]
description = "Remove built binaries"
run = "rm -rf bin/"

# =============================================================================
# Test tasks
# =============================================================================

[tasks.test]
description = "Run all tests"
run = "go test ./..."

[tasks."test:verbose"]
description = "Run tests with verbose output"
run = "go test -v ./..."

[tasks."test:coverage"]
description = "Generate coverage report"
run = """
#!/usr/bin/env bash
set -e
go test -coverprofile=coverage.out ./...
go tool cover -html=coverage.out -o coverage.html
echo "Coverage report: coverage.html"
"""

[tasks.bench]
description = "Run benchmarks"
run = "go test -bench=. -benchmem -benchtime=2s -count=1 -run=^$ ./pkg/net/"

# =============================================================================
# Development tasks
# =============================================================================

[tasks.fmt]
description = "Format code"
run = "go fmt ./..."

[tasks.vet]
description = "Run go vet"
run = "go vet ./..."

[tasks.lint]
description = "Run golangci-lint"
run = "golangci-lint run"

[tasks.tidy]
description = "Run go mod tidy"
run = "go mod tidy"

[tasks.check]
description = "Run all checks (fmt, vet, lint, test)"
depends = ["fmt", "vet", "lint", "test"]

# =============================================================================
# Kernel tasks
# =============================================================================

[tasks."kernel:build"]
alias = "kernel"
description = "Build kernels for all architectures"
run = "OUTPUT_DIR=$OUTPUT_DIR/kernels/$KERNEL_VERSION KERNEL_VERSION=$KERNEL_VERSION ARCH=all ./scripts/build-kernel.sh"

[tasks."kernel:x86_64"]
description = "Build kernel for x86_64 only"
run = "OUTPUT_DIR=$OUTPUT_DIR/kernels/$KERNEL_VERSION KERNEL_VERSION=$KERNEL_VERSION ARCH=x86_64 ./scripts/build-kernel.sh"

[tasks."kernel:arm64"]
description = "Build kernel for arm64 only"
run = "OUTPUT_DIR=$OUTPUT_DIR/kernels/$KERNEL_VERSION KERNEL_VERSION=$KERNEL_VERSION ARCH=arm64 ./scripts/build-kernel.sh"

[tasks."kernel:publish"]
description = "Publish kernels to GHCR"
run = "INPUT_DIR=$OUTPUT_DIR/kernels/$KERNEL_VERSION KERNEL_VERSION=$KERNEL_VERSION REGISTRY=$REGISTRY ./scripts/publish-kernel.sh"

[tasks."kernel:publish-latest"]
description = "Publish kernels and tag as latest"
run = "KERNEL_VERSION=$KERNEL_VERSION REGISTRY=$REGISTRY TAG_LATEST=true ./scripts/publish-kernel.sh"

[tasks."kernel:clean"]
description = "Clean kernel cache"
run = "rm -rf $OUTPUT_DIR/kernels"

# =============================================================================
# Rootfs tasks
# =============================================================================

[tasks."rootfs:docker"]
description = "Build rootfs using Docker (no sudo required)"
depends = ["build:guest"]
run = """
#!/usr/bin/env bash
set -e
IMAGE=${IMAGE:-standard}
mkdir -p $OUTPUT_DIR
cp bin/guest-agent /tmp/guest-agent
cp bin/guest-fused /tmp/guest-fused
docker run --rm --privileged \
    -v /tmp:/tmp \
    -v $PWD/scripts:/scripts:ro \
    -v $OUTPUT_DIR:$OUTPUT_DIR \
    -e IMAGE=$IMAGE \
    -e OUTPUT_DIR=$OUTPUT_DIR \
    alpine:3.19 \
    sh -c "apk add --no-cache bash e2fsprogs util-linux && /scripts/build-rootfs.sh"
"""

# =============================================================================
# Installation tasks
# =============================================================================

[tasks.install]
description = "Install matchlock to /usr/local/bin"
depends = ["build"]
run = """
#!/usr/bin/env bash
set -e
sudo cp bin/matchlock /usr/local/bin/matchlock
echo "Installed matchlock to /usr/local/bin"
"""

[tasks."install:firecracker"]
description = "Install Firecracker binary"
run = "./scripts/install-firecracker.sh"

# =============================================================================
# Combined tasks
# =============================================================================

[tasks.images]
description = "Build kernel + rootfs"
depends = ["kernel:build", "rootfs:docker"]

[tasks.setup]
description = "Full setup (firecracker + images + install)"
depends = ["install:firecracker", "images", "install"]
run = """
#!/usr/bin/env bash
echo ""
echo "============================================"
echo "Matchlock setup complete!"
echo "============================================"
echo ""
echo "Test with:"
echo "  sudo matchlock run --image alpine:latest echo 'Hello from matchlock'"
"""

[tasks."quick-test"]
description = "Quick test with built images"
depends = ["build"]
run = """
#!/usr/bin/env bash
set -e
if [ -f "$OUTPUT_DIR/kernels/$KERNEL_VERSION/kernel" ]; then
    echo "Testing matchlock..."
    sudo matchlock run --image alpine:latest echo "Matchlock works!"
else
    echo "Kernel not found. Run 'mise run kernel:build' first."
    exit 1
fi
"""

# =============================================================================
# macOS tasks (Apple Silicon)
# =============================================================================

[tasks."darwin:build"]
description = "Build and codesign CLI for macOS"
run = """
#!/usr/bin/env bash
set -e
mkdir -p bin

# Create entitlements file
cat > matchlock.entitlements << 'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>com.apple.security.virtualization</key>
    <true/>
</dict>
</plist>
EOF

go build -o bin/matchlock ./cmd/matchlock
codesign --entitlements matchlock.entitlements -f -s - bin/matchlock
echo "Built and signed bin/matchlock for macOS"
"""

[tasks."darwin:guest"]
description = "Build ARM64 guest binaries for macOS VMs"
run = """
#!/usr/bin/env bash
set -e
mkdir -p bin $OUTPUT_DIR
CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -trimpath -o bin/guest-agent ./cmd/guest-agent
CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -trimpath -o bin/guest-fused ./cmd/guest-fused
cp bin/guest-agent $OUTPUT_DIR/guest-agent
cp bin/guest-fused $OUTPUT_DIR/guest-fused
echo "Built ARM64 guest binaries in bin/ and $OUTPUT_DIR"
"""

[tasks."darwin:all"]
description = "Build CLI (codesigned) and ARM64 guest binaries for macOS"
depends = ["darwin:build", "darwin:guest"]

[tasks."darwin:setup"]
description = "Full macOS setup (build + sign + guest binaries)"
depends = ["darwin:build", "darwin:guest"]
run = """
#!/usr/bin/env bash
echo ""
echo "============================================"
echo "Matchlock macOS setup complete!"
echo "============================================"
echo ""
echo "Guest binaries installed to $OUTPUT_DIR"
echo ""
echo "Test with:"
echo "  ./bin/matchlock run --image alpine:latest echo 'Hello from macOS VM!'"
"""

[tasks."darwin:test"]
description = "Quick test on macOS"
depends = ["darwin:build", "darwin:guest"]
run = "./bin/matchlock run --image alpine:latest echo 'Matchlock works on macOS!'"
