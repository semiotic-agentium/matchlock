# Matchlock Development Dependencies
# Install with: mise install
# Run tasks with: mise run <task>

[tools]
go = "1.25"
golangci-lint = "1.62"
gh = "latest"
"go:github.com/google/go-containerregistry/cmd/crane" = "latest"

[env]
_.path = ["~/go/bin"]
KERNEL_VERSION = "6.1.137"
OUTPUT_DIR = "{{env.HOME}}/.cache/matchlock"
REGISTRY = "ghcr.io/jingkaihe/matchlock"

VERSION = "{{exec(command='echo ${VERSION:-$(cat VERSION.txt)}')}}"
GIT_COMMIT = "{{exec(command='echo ${GIT_COMMIT:-$(git rev-parse --short HEAD 2>/dev/null || echo unknown)}')}}"
BUILD_TIME = "{{exec(command='echo ${BUILD_TIME:-$(date -u \"+%a %b %d %H:%M:%S UTC %Y\")}')}}"
VERSION_PKG = "github.com/jingkaihe/matchlock/pkg/version"

# =============================================================================
# Build tasks
# =============================================================================

[tasks.build]
description = "Build CLI (codesigned on macOS) and guest binaries"
run = """
#!/usr/bin/env bash
set -e

if [ "$(uname -s)" = "Darwin" ] && [ "$(uname -m)" = "x86_64" ]; then
  echo "Error: Intel macOS is not supported. Please use Apple Silicon (arm64)."
  exit 1
fi

mkdir -p bin

LDFLAGS="-X '$VERSION_PKG.Version=$VERSION' -X '$VERSION_PKG.GitCommit=$GIT_COMMIT' -X '$VERSION_PKG.BuildTime=$BUILD_TIME'"
go build -ldflags="$LDFLAGS" -o bin/matchlock ./cmd/matchlock

# Codesign on macOS (Virtualization.framework requires entitlement)
if [ "$(uname -s)" = "Darwin" ]; then
  cat > matchlock.entitlements << 'ENTITLEMENTS'
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>com.apple.security.virtualization</key>
    <true/>
</dict>
</plist>
ENTITLEMENTS
  codesign --entitlements matchlock.entitlements -f -s - bin/matchlock
fi

# Build guest binaries (auto-detect arch)
GOARCH=$(uname -m | sed 's/x86_64/amd64/' | sed 's/aarch64/arm64/')
CGO_ENABLED=0 GOOS=linux GOARCH=$GOARCH go build -trimpath -o bin/guest-agent ./cmd/guest-agent
CGO_ENABLED=0 GOOS=linux GOARCH=$GOARCH go build -trimpath -o bin/guest-fused ./cmd/guest-fused

# Cache guest binaries on macOS
if [ "$(uname -s)" = "Darwin" ]; then
  mkdir -p "$OUTPUT_DIR"
  cp bin/guest-agent "$OUTPUT_DIR/guest-agent"
  cp bin/guest-fused "$OUTPUT_DIR/guest-fused"
fi

echo "Built: bin/matchlock, bin/guest-agent, bin/guest-fused ($GOARCH)"
"""

[tasks.clean]
description = "Remove built binaries"
run = "rm -rf bin/"

# =============================================================================
# Test tasks
# =============================================================================

[tasks.test]
description = "Run all tests"
run = "go test ./..."

[tasks."test:coverage"]
description = "Generate coverage report"
run = """
#!/usr/bin/env bash
set -e
go test -coverprofile=coverage.out ./...
go tool cover -html=coverage.out -o coverage.html
echo "Coverage report: coverage.html"
"""

[tasks.bench]
description = "Run benchmarks"
run = "go test -bench=. -benchmem -benchtime=2s -count=1 -run=^$ ./pkg/net/"

[tasks."test:acceptance"]
description = "Run acceptance tests (requires VM support â€” cannot run in CI)"
depends = ["build"]
run = """
#!/usr/bin/env bash
set -e
MATCHLOCK_BIN="$PWD/bin/matchlock" go test -tags acceptance -timeout 600s -v ./tests/acceptance/
"""

# =============================================================================
# Development tasks
# =============================================================================

[tasks.fmt]
description = "Format code"
run = "go fmt ./..."

[tasks.vet]
description = "Run go vet"
run = "go vet ./..."

[tasks.lint]
description = "Run golangci-lint"
run = "golangci-lint run"

[tasks.tidy]
description = "Run go mod tidy"
run = "go mod tidy"

[tasks.check]
description = "Run all checks (fmt, vet, lint, test)"
depends = ["fmt", "vet", "lint", "test"]

# =============================================================================
# Kernel tasks
# =============================================================================

[tasks."kernel:build"]
alias = "kernel"
description = "Build kernels for all architectures"
run = "OUTPUT_DIR=$OUTPUT_DIR/kernels/$KERNEL_VERSION KERNEL_VERSION=$KERNEL_VERSION ARCH=all ./scripts/build-kernel.sh"

[tasks."kernel:x86_64"]
description = "Build kernel for x86_64 only"
run = "OUTPUT_DIR=$OUTPUT_DIR/kernels/$KERNEL_VERSION KERNEL_VERSION=$KERNEL_VERSION ARCH=x86_64 ./scripts/build-kernel.sh"

[tasks."kernel:arm64"]
description = "Build kernel for arm64 only"
run = "OUTPUT_DIR=$OUTPUT_DIR/kernels/$KERNEL_VERSION KERNEL_VERSION=$KERNEL_VERSION ARCH=arm64 ./scripts/build-kernel.sh"

[tasks."kernel:publish"]
description = "Publish kernels to GHCR (pass TAG_LATEST=true to also tag as latest)"
run = "INPUT_DIR=$OUTPUT_DIR/kernels/$KERNEL_VERSION KERNEL_VERSION=$KERNEL_VERSION REGISTRY=$REGISTRY ./scripts/publish-kernel.sh"

[tasks."kernel:clean"]
description = "Clean kernel cache"
run = "rm -rf $OUTPUT_DIR/kernels"

# =============================================================================
# Rootfs tasks
# =============================================================================

[tasks."rootfs:docker"]
description = "Build rootfs using Docker (no sudo required)"
depends = ["build"]
run = """
#!/usr/bin/env bash
set -e
IMAGE=${IMAGE:-standard}
mkdir -p $OUTPUT_DIR
cp bin/guest-agent /tmp/guest-agent
cp bin/guest-fused /tmp/guest-fused
docker run --rm --privileged \
    -v /tmp:/tmp \
    -v $PWD/scripts:/scripts:ro \
    -v $OUTPUT_DIR:$OUTPUT_DIR \
    -e IMAGE=$IMAGE \
    -e OUTPUT_DIR=$OUTPUT_DIR \
    alpine:3.19 \
    sh -c "apk add --no-cache bash e2fsprogs util-linux && /scripts/build-rootfs.sh"
"""

# =============================================================================
# Installation & setup tasks
# =============================================================================

[tasks.install]
description = "Install matchlock to /usr/local/bin"
depends = ["build"]
run = """
#!/usr/bin/env bash
set -e
sudo cp bin/matchlock /usr/local/bin/matchlock
echo "Installed matchlock to /usr/local/bin"
"""

[tasks."install:firecracker"]
description = "Install Firecracker binary"
run = "./scripts/install-firecracker.sh"

[tasks.images]
description = "Build kernel + rootfs"
depends = ["kernel:build", "rootfs:docker"]

[tasks.setup]
description = "Full Linux setup (firecracker + images + install)"
depends = ["install:firecracker", "images", "install"]
run = """
#!/usr/bin/env bash
echo ""
echo "============================================"
echo "Matchlock setup complete!"
echo "============================================"
echo ""
echo "Test with:"
echo "  sudo matchlock run --image alpine:latest echo 'Hello from matchlock'"
"""

[tasks."setup:darwin"]
description = "Full macOS setup (build + guest binaries)"
depends = ["build"]
run = """
#!/usr/bin/env bash
echo ""
echo "============================================"
echo "Matchlock macOS setup complete!"
echo "============================================"
echo ""
echo "Guest binaries installed to $OUTPUT_DIR"
echo ""
echo "Test with:"
echo "  ./bin/matchlock run --image alpine:latest echo 'Hello from macOS VM!'"
"""

# =============================================================================
# Cross-build tasks (CI / release)
# =============================================================================

[tasks."cross-build:linux"]
description = "Cross-compile matchlock for Linux (amd64 + arm64)"
run = """
#!/usr/bin/env bash
set -e
mkdir -p bin
LDFLAGS="-s -w -X '$VERSION_PKG.Version=$VERSION' -X '$VERSION_PKG.GitCommit=$GIT_COMMIT' -X '$VERSION_PKG.BuildTime=$BUILD_TIME'"
CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags="$LDFLAGS" -o ./bin/matchlock-linux-amd64 ./cmd/matchlock/
CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -ldflags="$LDFLAGS" -o ./bin/matchlock-linux-arm64 ./cmd/matchlock/
echo "Built: matchlock-linux-amd64, matchlock-linux-arm64"
"""

[tasks."cross-build:darwin"]
description = "Build matchlock for macOS arm64 (requires Apple Silicon host for CGO)"
run = """
#!/usr/bin/env bash
set -e

if [ "$(uname -m)" = "x86_64" ]; then
  echo "Error: Intel macOS is not supported. Please use Apple Silicon (arm64)."
  exit 1
fi

mkdir -p bin
LDFLAGS="-s -w -X '$VERSION_PKG.Version=$VERSION' -X '$VERSION_PKG.GitCommit=$GIT_COMMIT' -X '$VERSION_PKG.BuildTime=$BUILD_TIME'"
go build -ldflags="$LDFLAGS" -o ./bin/matchlock-darwin-arm64 ./cmd/matchlock/
echo "Built: matchlock-darwin-arm64"
"""

[tasks."cross-build:guest"]
description = "Cross-compile guest binaries for all architectures"
run = """
#!/usr/bin/env bash
set -e
mkdir -p bin
for ARCH in amd64 arm64; do
  CGO_ENABLED=0 GOOS=linux GOARCH=$ARCH go build -trimpath -o bin/guest-agent-linux-${ARCH} ./cmd/guest-agent
  CGO_ENABLED=0 GOOS=linux GOARCH=$ARCH go build -trimpath -o bin/guest-fused-linux-${ARCH} ./cmd/guest-fused
done
echo "Built guest binaries for amd64 and arm64"
"""

# =============================================================================
# Release tasks
# =============================================================================

[tasks."release"]
description = "Create GitHub release with binaries (run on macOS for darwin builds)"
depends = ["cross-build:linux", "cross-build:darwin", "cross-build:guest"]
run = """
#!/usr/bin/env bash
set -e

echo "Creating GitHub release v$VERSION..."

# Collect all release artifacts
ARTIFACTS=()
for f in bin/matchlock-linux-amd64 bin/matchlock-linux-arm64 bin/matchlock-darwin-* bin/guest-agent-linux-* bin/guest-fused-linux-*; do
  [ -f "$f" ] && ARTIFACTS+=("$f")
done

if [ ${#ARTIFACTS[@]} -eq 0 ]; then
  echo "Error: no release artifacts found in bin/"
  exit 1
fi

echo "Uploading ${#ARTIFACTS[@]} artifacts..."
gh release create "v$VERSION" --title "v$VERSION" --generate-notes "${ARTIFACTS[@]}"
echo "GitHub release v$VERSION created successfully!"
"""

[tasks."push-tag"]
description = "Push version tag to trigger automated GitHub Actions release"
run = """
#!/usr/bin/env bash
set -e
echo "Creating and pushing tag v$VERSION..."
if git rev-parse "v$VERSION" >/dev/null 2>&1; then
  echo "Tag v$VERSION already exists locally. Pushing to origin..."
else
  echo "Creating new tag v$VERSION..."
  git tag "v$VERSION"
fi
git push origin "v$VERSION"
echo "Tag v$VERSION pushed successfully!"
echo "GitHub Actions will automatically create a release with binaries."
"""
